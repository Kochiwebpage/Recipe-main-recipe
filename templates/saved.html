{% extends 'index.html' %}
{% load static %}

{% block title %} Saved Recipes {% endblock %}

{% block content %}
  <h2 style="margin: 20px 0 0 650px; font-family: 'mv boli'; font-weight: 700;">Your Saved Recipes</h2>

  {% if saved_recipes %}
    <table style="margin: 20px 0 20px 500px; border-collapse: collapse; width: 600px;">
      <thead style="margin: 10px 0;">
        <tr>
          <th style="padding: 10px;">Image</th>
          <th style="padding: 10px;">Name</th>
          <th style="padding: 10px;">Action</th>
        </tr>
      </thead>
      <tbody>
        {% for recipe in saved_recipes %}
          <tr id="recipe{{ recipe.id }}" style="border-bottom: 1px solid #ddd;">
            <td style="padding: 10px;"><a href="{% url 'detailspage' recipe.id %}"><img src="{{ recipe.image.url }}" alt="{{ recipe.name }}" style="width: 150px; height: 100px;"></a></td>
            <td style="padding: 10px;">{{ recipe.name }}</td>
            <td style="padding: 10px;">
              <button class="btn btnSave" data-recipe-id="{{ recipe.id }}" data-saved="{{ recipe.is_saved }}" type="button" onclick="saveRecipe({{ recipe.id }})">
                {% if request.user in recipe.saved_by.all %}
                  <i class="fas fa-trash-alt" style="color:red;"></i>
                {% else %}
                  <i class="fas fa-trash-alt" style="color:black;"></i>
                {% endif %}
              </button>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p style="margin: 20px 0 0 700px; font-family: 'mv boli'; font-weight: 700;">No saved recipes yet</p>
  {% endif %}

  <style>
    .btnSave {
      background: none;
      border: none;
      outline: none;
      cursor: pointer;
    }
  </style>

  <script>
    function saveRecipe(pk) {
      const csrfToken = document.getElementsByName('csrfmiddlewaretoken')[0].value;

      fetch(`/your_unsave_endpoint/${pk}/`, {
          method: 'POST', // Use POST or DELETE based on your server implementation
          headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': csrfToken,
          },
      })
          .then(response => {
              if (response.ok) {
                  // Remove the row from the table if the server successfully removes the recipe
                  const rowToRemove = document.getElementById(`recipe${pk}`);
                  if (rowToRemove) {
                      rowToRemove.remove();
                  }
              } else {
                  console.error('Failed to remove recipe');
              }
          })
          .catch(error => {
              console.error('Error:', error);
          });
    }
  </script>
{% endblock %}